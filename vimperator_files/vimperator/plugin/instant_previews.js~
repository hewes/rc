let PLUGIN_INFO =
<VimperatorPlugin>
<name>instant_previews</name>
<description>This script allows you to use Instant Previews feature of Google Search with Vimperator.</description>
<version>0.1.0</version>
<author>zentooo</author>
<license>Creative Commons</license>
<detail><![CDATA[
    == Subject ==
    This script allows you use Google's Instant Previews with Vimperator.
]]></detail>
</VimperatorPlugin>;

(function(lib) {

  var ly = liberator.plugins.libly.$U;

  commands.addUserCommand( ["instant"], "enable Google Instant Viewer plugin", function(args) {

      var tab = getBrowser().mCurrentTab,
          wrapped = tab.linkedBrowser.contentWindow.wrappedJSObject,
          vscs = wrapped.document.getElementsByClassName("vsc"),
          event = wrapped.document.createEvent("MouseEvents"),
          offset = ly.getElementPosition(vscs[0]).top * 2,
          current = 0;


      event.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
      vscs[current].dispatchEvent(event);
      event.initMouseEvent("mouseover", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
      vscs[current].dispatchEvent(event);

      mappings.addUserMap([modes.NORMAL], ["j"], "iterate search results", function() {

        vscs = wrapped.document.getElementsByClassName("vsc");

        if ( current < vscs.length - 1 ) {
          vscs[++current].dispatchEvent(event);
          buffer.scrollTo(0, ly.getElementPosition(vscs[current]).top - offset);
        }

      }, { matchingUrls: ["www\.google\.co\.[a-z]{2}/search"] });

      mappings.addUserMap([modes.NORMAL], ["k"], "reverse iterate search results", function() {

        if ( current > 0 ) {
          vscs = wrapped.document.getElementsByClassName("vsc");
          vscs[--current].dispatchEvent(event);
          buffer.scrollTo(0, ly.getElementPosition(vscs[current]).top - offset);
        }

      }, { matchingUrls: ["www\.google\.co\.[a-z]{2}/search"] });


      mappings.addUserMap([modes.NORMAL], ["gg"], "go to the top", function() {

        current = -1;
        buffer.scrollTo(0, 0);

      }, { matchingUrls: ["www\.google\.co\.[a-z]{2}/search"] });


      mappings.addUserMap([modes.NORMAL], ["<C-m>"], "open current item with a new tab", function() {

        var href = vscs[current].attributes.getNamedItem("rawurl").nodeValue;
        lib.open(href, { where: lib.NEW_TAB });

      }, { matchingUrls: ["www\.google\.co\.[a-z]{2}/search"] });

    }
  );

  autocommands.add("LocationChange", "www\.google\.co\.[a-z]{2}/search", "instant");

})(liberator);
